<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2019-04-03 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190403" />
    <meta http-equiv="Content-Language" content="en" />
    <title>WrzasqPl Parent OpenSouece &#x2013; Travis-based deployment pipeline</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>WrzasqPl Parent OpenSouece</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.parent/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl Parent Generic"><span class="none"></span>WrzasqPl Parent Generic</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deploy.html" title="Deploy profile"><span class="none"></span>Deploy profile</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Travis CI</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.parent.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2016 - 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>Travis-based deployment pipeline</h1>
<p><b>Note:</b> This page plays role mostly of the internal guideline for <b>Rafa&#x142; Wrzeszcz - Wrzasq.pl</b> projects, but it&#x2019;s entirely general and you can re-use the same flow with your own projects.</p>
<div class="section">
<h2><a name="Concept"></a>Concept</h2>
<div class="section">
<h3><a name="Principles"></a>Principles</h3>
<ul>

<li>When possible rely on <b>Maven</b>, rather than CI to avoid lock-in with particular CI solution.</li>
<li>Try to automate as much as possible.</li>
</ul></div>
<div class="section">
<h3><a name="Actions"></a>Actions</h3>
<p>Our current deployment involves following specific actions:</p>
<ul>

<li>Signing artifacts with GPG key.</li>
<li>Publishing artifacts (together with GPG checksums) to Sonatype Nexus.</li>
<li>Publishing GitHub page.</li>
<li>Creating Git tag.</li>
</ul></div>
<div class="section">
<h3><a name="Approach"></a>Approach</h3>
<p>The flow is as follows - when the release is about to happend, it has to be prepared on <tt>master</tt> branch (the contnet of the repository should reflect the desired release state), all versions must be set (preferable with <tt>mvn versions:set</tt> plugin call) to desired value (must not contain <tt>-SNAPSHOT</tt> suffix). Such prepared commit goes to <tt>master</tt> branch and after pushing to <b>GitHub</b> repository it triggers the build on <b>Travis</b> which involves deployment cycle.</p>
<p><b>Note:</b> Commits to master should be done only when the stable release is meant to happen with the release version set in <tt>pom.xml</tt> file.</p>
<p><b>Note:</b> We decided to rely on <tt>master</tt> branch instead of a tag, as tag creation can be easily automated. Additionally having tagging as part of deployment process can prevent us from creating tags when the build doesn&#x2019;t succeed.</p>
<p>As major and minor releases usually demand some manual changes it&#x2019;s release process need to be initialized manually. However for current active version (being stored on branch <tt>develop</tt>), each update automatically triggers a release version update with full deployment cycle.</p></div></div>
<div class="section">
<h2><a name="Setup"></a>Setup</h2>
<p>As the deployment process relies on some sensitive data, like <b>Sonatype</b> credentials, <b>GitHub</b> token etc., to pass them safely into the build we use environment variables encoded with <b>Travis</b> repository key. To pass large blobs like keys, we ue additional secret string that we randomly generate on our own for each repository, store it encoded as well and use as a key to encrypt/decrypt files with <tt>openssl</tt>.</p>
<p><b>Note:</b> Keep in mind that the private key of the pair is never exposed, even to us, so whenever you want to encode data that may be later needed by you keep the copy of it.</p>
<p>To keep our project <b>Maven</b> setup independent from the choosen deployment pipeline we keep dedicated <tt>settings.xml</tt> for <b>Travis</b> deploys that populates the credentials and other properties.</p>
<p><b>Note:</b> Everything related to <b>Travis</b>-based deployment should go into <tt>.travis/</tt> subdirectory.</p>
<p>To prepare the repository to use <b>Travis</b> for deployment automation first of all pick a secret string for it (keep it!), for example using (replace any non-alphanumerical character of the output with random character to avoid possible escaping):</p>

<div>
<div>
<pre class="source">cat /dev/urandom | base64 | head -c 16
</pre></div></div>

<p>Export it as a shell environment variable to make it reusable in further calls:</p>

<div>
<div>
<pre class="source">export SECRET=&lt;secret string&gt;
</pre></div></div>

<div class="section">
<h3><a name="Keys"></a>Keys</h3>
<p>Use the secret to encode key files. We need <b>SSH</b> public key for <b>GitHub</b> access and <b>GPG</b> key for signing artifacts to be deployed.</p>
<p>To generates <b>SSH</b> key use:</p>

<div>
<div>
<pre class="source">ssh-keygen -t rsa -b 4096 -C &quot;Travis CI&quot;
</pre></div></div>

<ul>

<li>Copy public key and put it as a deployment key of your <b>GitHub</b> repository (grant it write access - it will be used for pushing tags).</li>
<li>Encrypt private key file:</li>
</ul>

<div>
<div>
<pre class="source">openssl aes-256-cbc -md sha256 -k &quot;$SECRET&quot; -in .travis/id_rsa -out .travis/id_rsa.enc
</pre></div></div>

<p>To export and encrypt <b>GPG</b> (the one associated with <b>Sonatype</b> account, for tutorial about generating the key itself use <b>Google</b>) do:</p>

<div>
<div>
<pre class="source">gpg -a --export deployer@account.com &gt; .travis/gpg_key
gpg -a --export-secret-keys deployer@account.com &gt;&gt; .travis/gpg_key
openssl aes-256-cbc -md sha256 -k &quot;$SECRET&quot; -in .travis/gpg_key -out .travis/gpg_key.enc
</pre></div></div>

<p><b>Note:</b> Never, ever commit unencrypted keys to the repositories (not even private onces)!</p></div>
<div class="section">
<h3><a name="Environment_variables"></a>Environment variables</h3>
<p>To pass the short, or variable data into deployment builds we use encrypted environment variables. Following environment variables are used:</p>
<ul>

<li><tt>OSSRH_USERNAME</tt> - <b>Sonatype</b> deployments accoung login;</li>
<li><tt>OSSRH_PASSWORD</tt> - <b>Sonatype</b> deployments accoung password;</li>
<li><tt>GPG_PASSPHRASE</tt> - password for <b>GPG</b> key;</li>
<li><tt>GITHUB_TOKEN</tt> - <b>GitHub</b> access token, used for deploying pages;</li>
<li><tt>SECRET</tt> - our secret string used for decrypting key files.</li>
</ul>
<p>To generate encrypted values for them call:</p>

<div>
<div>
<pre class="source">travis encrypt OSSRH_USERNAME=&lt;Sonatype account login&gt;
travis encrypt OSSRH_PASSWORD=&lt;Sonatype account password&gt;
travis encrypt GPG_PASSPHRASE=&lt;GPG key passphrase&gt;
travis encrypt GITHUB_TOKEN=&lt;GitHub access token&gt;
travis encrypt SECRET=$SECRET
</pre></div></div>

<p>Save produced strings in <tt>.travis.yml</tt>:</p>

<div>
<div>
<pre class="source">env:
    global:
        -
            secure: &#x2026;
        -
            secure: &#x2026;
        &#x2026;
</pre></div></div>
</div>
<div class="section">
<h3><a name="Plain_files"></a>Plain files</h3>
<p>To bind the described setup with <b>Travis</b> build cycle you will need two files - there is no point in describing them here as the description may most likely go outdated and miss the real requirements, so the best way is to just look into this repository examples and use them as a templates:</p>
<ul>

<li><tt>.travis.yml</tt> - sections <tt>before_deploy</tt> to prepare required deployment environment and <tt>deploy</tt> for actual deployment command;</li>
<li><tt>.travis/settings.xml</tt> - file that contains mapping of environment variables into <b>Maven</b> properties of the deployment configuration;</li>
<li><tt>.travis/release.sh</tt> - script containing CD pipeline logic as <b>Travis</b> doesn&#x2019;t support complex deployment scripts.</li>
</ul></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2015&#x2013;2019
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2019-04-03</li>
          <li id="projectVersion" class="pull-right">Version: 1.0.8</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
