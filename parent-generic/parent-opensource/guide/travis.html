<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-10-14 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20201014" />
    <meta http-equiv="Content-Language" content="en" />
    <title>WrzasqPl Parent OpenSouece &#x2013; Travis-based deployment pipeline</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>WrzasqPl Parent OpenSouece</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.parent/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl Parent Generic"><span class="none"></span>WrzasqPl Parent Generic</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deploy.html" title="Deploy profile"><span class="none"></span>Deploy profile</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Travis CI</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.parent.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2016 - 2019 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>Travis-based deployment pipeline</h1>
<p><b>Note:</b> This page plays role mostly of the internal guideline for <b>Rafa&#x142; Wrzeszcz - Wrzasq.pl</b> projects, but it&#x2019;s entirely general and you can re-use the same flow with your own projects.</p><section>
<h2><a name="Concept"></a>Concept</h2><section>
<h3><a name="Principles"></a>Principles</h3>
<ul>

<li>When possible rely on <b>Maven</b>, rather than CI to avoid lock-in with particular CI solution.</li>
<li>Try to automate as much as possible.</li>
</ul></section><section>
<h3><a name="Actions"></a>Actions</h3>
<p>Our current deployment involves following specific actions:</p>
<ul>

<li>Signing artifacts with GPG key.</li>
<li>Publishing artifacts (together with GPG checksums) to Sonatype Nexus.</li>
<li>Publishing GitHub page.</li>
<li>Creating Git tag.</li>
</ul></section><section>
<h3><a name="Approach"></a>Approach</h3>
<p>Each commit to <code>master</code> should trigger roll-out of next iterative version. Pipeline should handle versioning, tagging and releasing artifacts to repositories (including site generation)</p>
<p>Deployment pipeline will automatically increase release number. If new major or minor release is to be performed, version needs to be set manually before committing files (in <code>pom.xml</code> of root module).</p></section></section><section>
<h2><a name="Setup"></a>Setup</h2>
<p>As the deployment process relies on some sensitive data, like <b>Sonatype</b> credentials, <b>GitHub</b> token etc., to pass them safely into the build we use environment variables encoded with <b>Travis</b> repository key. To pass large blobs like keys, we ue additional secret string that we randomly generate on our own for each repository, store it encoded as well and use as a key to encrypt/decrypt files with <code>openssl</code>.</p>
<p><b>Note:</b> Keep in mind that the private key of the pair is never exposed, even to us, so whenever you want to encode data that may be later needed by you keep the copy of it.</p>
<p>To keep our project <b>Maven</b> setup independent from the choosen deployment pipeline we keep dedicated <code>settings.xml</code> for <b>Travis</b> deploys that populates the credentials and other properties.</p>
<p><b>Note:</b> Everything related to <b>Travis</b>-based deployment should go into <code>.travis/</code> subdirectory.</p>
<p>To prepare the repository to use <b>Travis</b> for deployment automation first of all pick a secret string for it (keep it!), for example using (replace any non-alphanumerical character of the output with random character to avoid possible escaping):</p>

<div class="source">
<div class="source"><pre class="prettyprint">cat /dev/urandom | base64 | head -c 16
</pre></div></div>

<p>Export it as a shell environment variable to make it reusable in further calls:</p>

<div class="source">
<div class="source"><pre class="prettyprint">export SECRET=&lt;secret string&gt;
</pre></div></div>
<section>
<h3><a name="Keys"></a>Keys</h3>
<p>Use the secret to encode key files. We need <b>SSH</b> public key for <b>GitHub</b> access and <b>GPG</b> key for signing artifacts to be deployed.</p>
<p>To generates <b>SSH</b> key use:</p>

<div class="source">
<div class="source"><pre class="prettyprint">ssh-keygen -t rsa -b 4096 -C &quot;Travis CI&quot;
</pre></div></div>

<ul>

<li>Copy public key and put it as a deployment key of your <b>GitHub</b> repository (grant it write access - it will be used for pushing tags).</li>
<li>Encrypt private key file:</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">openssl aes-256-cbc -md sha256 -k &quot;$SECRET&quot; -in .travis/id_rsa -out .travis/id_rsa.enc
</pre></div></div>

<p>To export and encrypt <b>GPG</b> (the one associated with <b>Sonatype</b> account, for tutorial about generating the key itself use <b>Google</b>) do:</p>

<div class="source">
<div class="source"><pre class="prettyprint">gpg -a --export deployer@account.com &gt; .travis/gpg_key
gpg -a --export-secret-keys deployer@account.com &gt;&gt; .travis/gpg_key
openssl aes-256-cbc -md sha256 -k &quot;$SECRET&quot; -in .travis/gpg_key -out .travis/gpg_key.enc
</pre></div></div>

<p><b>Note:</b> Never, ever commit unencrypted keys to the repositories (not even private onces)!</p></section><section>
<h3><a name="Environment_variables"></a>Environment variables</h3>
<p>To pass the short, or variable data into deployment builds we use encrypted environment variables. Following environment variables are used:</p>
<ul>

<li><code>OSSRH_USERNAME</code> - <b>Sonatype</b> deployments accoung login;</li>
<li><code>OSSRH_PASSWORD</code> - <b>Sonatype</b> deployments accoung password;</li>
<li><code>GPG_PASSPHRASE</code> - password for <b>GPG</b> key;</li>
<li><code>GITHUB_TOKEN</code> - <b>GitHub</b> access token, used for deploying pages;</li>
<li><code>SECRET</code> - our secret string used for decrypting key files.</li>
</ul>
<p>To generate encrypted values for them call:</p>

<div class="source">
<div class="source"><pre class="prettyprint">travis encrypt OSSRH_USERNAME=&lt;Sonatype account login&gt;
travis encrypt OSSRH_PASSWORD=&lt;Sonatype account password&gt;
travis encrypt GPG_PASSPHRASE=&lt;GPG key passphrase&gt;
travis encrypt GITHUB_TOKEN=&lt;GitHub access token&gt;
travis encrypt SECRET=$SECRET
</pre></div></div>

<p>Save produced strings in <code>.travis.yml</code>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">env:
    global:
        -
            secure: &#x2026;
        -
            secure: &#x2026;
        &#x2026;
</pre></div></div>
</section><section>
<h3><a name="Plain_files"></a>Plain files</h3>
<p>To bind the described setup with <b>Travis</b> build cycle you will need two files - there is no point in describing them here as the description may most likely go outdated and miss the real requirements, so the best way is to just look into this repository examples and use them as a templates:</p>
<ul>

<li><code>.travis.yml</code> - sections <code>before_deploy</code> to prepare required deployment environment and <code>deploy</code> for actual deployment command;</li>
<li><code>.travis/settings.xml</code> - file that contains mapping of environment variables into <b>Maven</b> properties of the deployment configuration;</li>
<li><code>.travis/release.sh</code> - script containing CD pipeline logic as <b>Travis</b> doesn&#x2019;t support complex deployment scripts.</li>
</ul></section></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2015&#x2013;2020
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2020-10-14</li>
          <li id="projectVersion" class="pull-right">Version: 1.2.0</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
